!function r(o,i,u){function a(n,e){if(!i[n]){if(!o[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(c)return c(n,!0);e=new Error("Cannot find module '"+n+"'");throw e.code="MODULE_NOT_FOUND",e}t=i[n]={exports:{}};o[n][0].call(t.exports,function(e){var t=o[n][1][e];return a(t||e)},t,t.exports,r,o,i,u)}return i[n].exports}for(var c="function"==typeof require&&require,e=0;e<u.length;e++)a(u[e]);return a}({1:[function(e,t,n){t.exports=function(){for(var e={},t=0;t<arguments.length;t++){var n,r=arguments[t];for(n in r)o.call(r,n)&&(e[n]=r[n])}return e};var o=Object.prototype.hasOwnProperty},{}],2:[function(e,t,n){"use strict";function c(o,i,u){if(Array.isArray(i)&&(i=i.join("/")),o)return new l(function(e,t){var n=new XMLHttpRequest,r=(u=u||{},"?"+Object.keys(u).map(function(e){return[e,encodeURIComponent(u[e])].join("=")}).join("&"));n.open("GET","https://api.helpscout.net/v2/"+i+r,!0),n.setRequestHeader("Authorization","Bearer "+o),n.onload=function(){switch(n.status){case 200:case 201:case 204:try{return e(JSON.parse(n.responseText))}catch(e){return t(new s.InvalidResponse(e.message))}default:return t(f(n.status))}},n.send()});throw new s.Unauthorized}function r(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r=[],o=null,i=null,u=null,a=null,c="all";return t.mailboxes&&!t.folders&&(u=t.mailboxes.join(",")),t.assigned&&(o=t.assigned.map(function(e){return e.id}).join(",")),t.tags&&(i=t.tags.join(",")),t.folders&&(a=t.folders.map(function(e){return"number"==typeof e?e:(1===t.folders.length&&-1!==["assigned","mytickets"].indexOf(e.type)&&(c="open"),e.id)})),t.number&&r.push("number:"+t.number),0<r.length&&(n.query=r.map(function(e){return"("+e+")"}).join(" AND ")),o&&(n.assigned_to=o),a&&(n.folder=a),u&&(n.mailbox=u),c&&(n.status=c),i&&(n.tag=i),m(e,"conversations",n).get("_embedded").get("conversations").catch(function(){return[]})}function o(e,t){return m(e,["mailboxes",t,"folders"]).get("_embedded").get("folders").then(function(e){return Array.isArray(e)?e.filter(function(e){return"drafts"!==e.type}):e})}var s=e("./helpscout-error"),l=(e("xtend"),window.TrelloPowerUp.Promise),i={400:s.BadRequest,401:s.Unauthorized,402:s.Suspended,403:s.AccessDenied,404:s.NotFound,405:s.InvalidMethod,500:s.InternalServerError,503:s.ServiceUnavailable},f=function(e,t){return new(i[e]||s.Unknown)(t||"")},h=function(n){return new l(function(e,t){return l.all([n.get("board","private","token"),n.get("organization","private","token")]).spread(function(e,t){return e||t}).then(e).catch(t)})},d=!0,p=function(){d=!1,setTimeout(function(){d=!0},5e3)},m=function r(i,o,u,a){var e,n;return a?(a.retries++,2<a.retries||a.error&&a.error.constructor!==s.Unauthorized?a.reject(a.error):(e=function(){return h(i).then(function(e){return c(e,o,u)}).then(a.resolve).catch(function(e){return a.error=e,r(i,o,u,a)})},d?(n=i,new l(function(e,t){return l.all([n.get("board","private","refreshToken"),n.get("organization","private","refreshToken")]).spread(function(e,t){return e||t}).then(e).catch(t)}).then(function(e){return t=i,o=e,new l(function(n,r){return h(t).then(function(e){var t=new XMLHttpRequest;t.open("POST","https://qxazrc75ed.execute-api.us-east-1.amazonaws.com/prod/refresh",!0),t.setRequestHeader("Content-Type","application/json"),t.onload=function(){if(200===t.status)try{var e=JSON.parse(t.responseText);return n(e)}catch(e){return r(new s.InvalidResponse(e.message))}return r(f(t.status))},t.send(JSON.stringify({accessToken:e,refreshToken:o}))}).catch(r)});var t,o}).then(function(e){return t=i,(n=e)&&n.token&&n.refreshToken?t.set("organization","private",n).catch(t.NotHandled,function(){return t.set("board","private",n)}):(p(),l.resolve());var t,n}).then(e).catch(e)):e())):new l(function(t,n){return a={retries:0},h(i).then(function(e){if(e)return c(e,o,u);throw new s.BadRequest}).then(t).catch(s.BadRequest,function(){return n(s.Unauthorized())}).catch(function(e){return a.error=e,a.reject=n,a.resolve=t,r(i,o,u,a)})})};t.exports={get:m,getWithToken:c,getConversation:function(e,t){return m(e,["conversations",t])},getConversationsByNumber:function(e,t){return r(e,{number:t})},getMailbox:function(e,t){return m(e,["mailboxes",t])},getAllMailboxes:function(e){return m(e,"mailboxes").get("_embedded").get("mailboxes")},getSearch:r,getMe:function(e){return m(e,"users/me")},getAllUsers:function(e){return m(e,["users","all"]).get("_embedded").get("users")},getFoldersForMailbox:o,getAllFolders:function(t){return t.get("board","shared","mailboxes",[]).tap(function(e){if(0==e.length)throw new s.InvalidMailbox}).map(function(e){return o(t,e)}).then(function(e){return Array.prototype.concat.apply([],e)})}}},{"./helpscout-error":7,xtend:1}],3:[function(e,t,n){"use strict";function o(e,n){return new c(function(t){return e.popup({title:e.localizeKey("authorize"),url:"authorize.html",callback:function(e){return n(e).then(t)},height:103})})}function i(n,e){return u(n,e,{getList:function(e){return r.getAllMailboxes(e).map(function(e){return{name:e.name,mailbox:e}})},set:function(t){return n.get("board","shared","mailboxes",[]).then(function(e){if(-1===e.indexOf(t.mailbox.id))return(e=e.slice()).push(t.mailbox.id),n.set("board","shared","mailboxes",e)})},title:n.localizeKey("choose_a_mailbox"),search:{count:10,placeholder:n.localizeKey("search_for_mailbox"),empty:n.localizeKey("no_mailboxes_found")}})}var r=e("./api"),a=e("./helpscout-error"),c=(e("xtend"),window.TrelloPowerUp.Promise),s=function(e,r){return function t(n){return r(n).catch(a,function(e){if(e instanceof a.Unauthorized)return o(n,t);if(e instanceof a.InvalidMailbox)return i(n,t);throw e})}(e)},u=function(e,i,u,t){return s(e,function(o){return u.getList(o,t).then(function(r){return new c(function(n){var t=u.nameAttr||"name",e=r.map(function(e){return{text:e[t],callback:function(t){return c.try(function(){return u.set(e)}).then(function(e){return i(t,e)}).then(n)}}});return o.popup({title:u.title,items:e,search:u.search})})}).catch(function(e){throw new a.Unauthorized})})};t.exports={handleErrors:s,chooseMailbox:i,chooseUser:function(e,t){return u(e,t,{getList:function(e){return r.getAllUsers(e).map(function(e){return{name:[e.firstName,e.lastName].join(" "),user:e}})},set:function(e){return{user:e.user}},title:e.localizeKey("choose_a_person"),search:{count:10,placeholder:e.localizeKey("search_for_person"),empty:e.localizeKey("nobody_found")}})},chooseFolder:function(e,t){return u(e,t,{getList:function(e){return r.getAllFolders(e).filter(function(e){return 0<e.totalCount})},set:function(e){return{folder:e}},title:e.localizeKey("choose_a_folder"),search:{count:10,placeholder:e.localizeKey("search_for_folder"),empty:e.localizeKey("no_folder_found")}})}}},{"./api":2,"./helpscout-error":7,xtend:1}],4:[function(e,t,n){"use strict";var o=e("./api"),i=e("./data-for-url"),r=e("./helpscout-button"),u=e("./helpscout-error"),a=e("./helpscout-urls"),c=e("./i18n-settings"),s=e("xtend"),l=window.TrelloPowerUp.Promise,f="./images/helpscout-icon.svg";window.TrelloPowerUp.initialize({"attachment-sections":function(e,t){t=t.entries.filter(function(e){return a.isConversation(e.url)});return 0==t.length?[]:{icon:f,title:e.localizeKey("help_scout_conversations"),claimed:t,content:{type:"iframe",url:e.signUrl("./conversations.html")}}},"attachment-thumbnail":function(e,t){var n,r;if(a.isHelpScout(t.url))return n=a.parse(t.url),r={image:{url:f,logo:!0},title:n.number?e.localizeKey("conversation_number",{number:n.number}):t.name||t.url,openText:e.localizeKey("open_in_help_scout"),url:t.url},l.try(function(){if(n.isConversation)return i(e,t.url).then(function(e){return s(r,e)});throw new u.NotFound}).catch(u,function(){return r});throw e.NotHandled()},"board-buttons":function(t){function n(e){return"https://secure.helpscout.net/mailbox/"+e.slug+"/"}function r(t){return t.get("board","shared","mailboxes",[]).map(function(e){return o.getMailbox(t,e).catch(u,function(){return null})}).filter(function(e){return e})}return r(t).then(function(e){return 0==e.length?[]:1==e.length?[{icon:f,text:e[0].name,url:n(e[0])}]:[{icon:f,text:t.localizeKey("number_of_mailboxes",{count:e.length}),callback:function(t){return r(t).then(function(e){return t.popup({title:t.localizeKey("mailboxes"),items:e.map(function(e){return{text:e.name,url:n(e)}})})})}}]})},"card-badges":function(e){return e.card("attachments").get("attachments").filter(function(e){return a.isConversation(e.url)}).then(function(e){return 0<e.length?[{text:e.length,icon:f}]:[]})},"card-buttons":function(t){return t.memberCanWriteToModel("card")?o.getMe(t).then(function(e){return[{icon:f,text:t.localizeKey("help_scout"),callback:r}]}).catch(function(){return[{icon:f,text:t.localizeKey("help_scout"),callback:function(e){return e.popup({title:e.localizeKey("help_scout_settings"),url:"authorize.html",height:160})}}]}):[]},"card-from-url":function(e,t){return i(e,t.url).then(function(e){return{name:e.title,desc:e.desc}})},"format-url":function(e,t){return i(e,t.url,t.name).then(function(e){return{icon:f,text:e.title}}).catch(u,function(){throw e.NotHandled()})},"show-settings":function(e){return e.popup({title:e.localizeKey("help_scout_settings"),url:"settings.html",height:160})}},{localization:c})},{"./api":2,"./data-for-url":5,"./helpscout-button":6,"./helpscout-error":7,"./helpscout-urls":8,"./i18n-settings":9,xtend:1}],5:[function(e,t,n){"use strict";var r=e("./api"),i=e("./helpscout-error"),u=e("./helpscout-urls"),a=window.TrelloPowerUp.Promise;t.exports=function(t,o,n){return a.try(function(){var e=u.parse(o);if(e.isHelpScout)return a.try(function(){if(e.isConversation)return r.getConversation(t,e.conversation);throw new i.NotFound}).then(function(e){var t,n=null,r=(e.createdBy&&(r=e.createdBy.firstName,t=e.createdBy.lastName,r)&&t&&(n=[r,t].join(" ")),e.preview);return{url:o,title:e.subject,created:Date.parse(e.createdAt),createdBy:n,modified:Date.parse(e.modifiedAt),desc:r}}).catch(i,function(){return{url:o,title:n||o}});throw t.NotHandled("not a helpscout url")})}},{"./api":2,"./helpscout-error":7,"./helpscout-urls":8}],6:[function(e,t,n){"use strict";function c(e){return e.map(function(t){return m(t,{callback:function(e){return e.attach({url:t.url,name:t.text}).then(function(){return e.closePopup()})}})})}function i(o,t){function i(e,t){return(t?e.filter(function(e){return!!e.text&&0<=e.text.toLowerCase().indexOf(t.toLowerCase())}):e).slice(0,10)}var u=[],a=void 0;return function(e,r){return d.handleErrors(e,function(e){return e.popup({title:t.getTitle(r)||e.localizeKey("help_scout"),items:function(e,n){return new p(function(t){return r===a&&0<u.length?t(i(u,n.search)):(u=[],o(e,a=r).then(function(e){return u=c(e),t(i(u,n.search))}))})},search:m(t.search,{searching:e.localizeKey("loading_ellipsis"),debounce:100})})})}}function u(e){return{url:r(e),text:e.subject}}function a(t,e){return t.get("board","shared","mailboxes",[]).then(function(e){return h.getSearch(t,{mailboxes:e},{sortField:"modifiedAt",sortOrder:"desc"}).map(u)})}function s(n,e){return p.all([n.get("board","shared","mailboxes",[]),h.getMe(n)]).spread(function(e,t){return h.getSearch(n,{mailboxes:e,assigned:[t]},{sortField:"modifiedAt",sortOrder:"desc"}).map(u)})}function l(n,r){return p.all([n.get("board","shared","mailboxes",[]),h.getMe(n)]).spread(function(e,t){return h.getSearch(n,{mailboxes:e,assigned:[r.user]},{sortField:"modifiedAt",sortOrder:"desc"}).map(u)})}function f(t,n){return t.get("board","shared","mailboxes",[]).then(function(e){return h.getSearch(t,{mailboxes:e,folders:[n.folder]},{sortField:"modifiedAt",sortOrder:"desc"}).map(u)})}var h=e("./api"),d=e("./choosers"),p=(e("./helpscout-error"),window.TrelloPowerUp.Promise),m=e("xtend"),r=function(e){return["https://secure.helpscout.net/conversation",e.id,e.number].join("/")};t.exports=function(t){var n,r,o={placeholder:t.localizeKey("search_conversations"),empty:t.localizeKey("no_conversations_found"),count:10};return t.popup({title:t.localizeKey("help_scout"),items:[{text:t.localizeKey("attach_tag"),callback:function(e,t){return e.popup({title:e.localizeKey("attach_tag"),items:function(r,o){return new p(function(e){var t,n;return""!==o.search?(t=r,n=o.search,t.get("board","shared","mailboxes",[]).then(function(e){return h.getSearch(t,{mailboxes:e,tags:[n]},{sortField:"modifiedAt",sortOrder:"desc"}).map(u)}).then(function(e){return e&&e.length&&10<e.length?e.slice(0,10):e}).then(c).then(e).catch(function(){e([])})):e([])})},search:m(o,{debounce:300,searching:e.localizeKey("searching_help_scout")})})}},{text:t.localizeKey("attach_conversation_id"),callback:function(e,t){return e.popup({title:e.localizeKey("attach_conversation_id"),items:function(n,r){return new p(function(e){var t;return""!==r.search?(t=r.search,h.getConversationsByNumber(n,t).map(u).then(function(e){return e&&e.length&&10<e.length?e.slice(0,10):e}).then(c).then(e).catch(function(){e([])})):e([])})},search:m(o,{debounce:300,searching:e.localizeKey("searching_help_scout")})})}},{text:t.localizeKey("attach_recently_updated_conversation"),callback:i(a,{getTitle:function(e){return t.localizeKey("recently_updated")},search:o})},{text:t.localizeKey("attach_conversation_assigned_to_me"),callback:i(s,{getTitle:function(e){return t.localizeKey("assigned_to_you")},search:o})},{text:t.localizeKey("attach_conversation_assigned_to_someone"),callback:(r=i(l,{getTitle:function(e){return t.localizeKey("assigned_to_first_last",{firstName:e.user.firstName,lastName:e.user.lastName})},search:o}),function(e){return d.chooseUser(e,r)})},{text:t.localizeKey("attach_conversation_from_folder"),callback:(n=i(f,{getTitle:function(e){return t.localizeKey("in_folder",{folderName:e.folder.name})},search:o}),function(e){return d.chooseFolder(e,n)})}]})}},{"./api":2,"./choosers":3,"./helpscout-error":7,xtend:1}],7:[function(e,t,n){"use strict";t.exports=window.TrelloPowerUp.util.makeErrorEnum("HelpScout",["BadRequest","Unauthorized","Suspended","AccessDenied","NotFound","InvalidMethod","InternalServerError","ServiceUnavailable","Unknown","InvalidResponse","InvalidMailbox"])},{}],8:[function(e,t,n){"use strict";function r(e){return 0===e.indexOf(i)}function o(e){var t={url:e};return r(e)&&(t.isHelpScout=!0,"conversation"==(e=e.replace(i,"").replace(/[?#].*$/).split("/"))[0])&&(t.conversation=e[1],t.number=e[2],t.isConversation=!(!t.conversation||!t.number)),t}var i="https://secure.helpscout.net/";t.exports={parse:o,isHelpScout:r,isConversation:function(e){return o(e).isConversation}}},{}],9:[function(e,t,n){"use strict";t.exports={defaultLocale:"en",supportedLocales:["en"],resourceUrl:"./strings/{locale}.json"}},{}]},{},[4]);
